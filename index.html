<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Story Hours Calculator (Pro Version)</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        input {
            background: white !important;
        }
        .red {
            color: red;
            font-weight: bold;
        }
    </style>
</head>

<body class="bg-gray-100 p-6">

<!-- MAIN CONTAINER -->
<div class="max-w-5xl mx-auto space-y-10">

    <!-- TITLE -->
    <h1 class="text-3xl font-bold text-gray-800 text-center">
        Story Hours Calculator
    </h1>


    <!-- ====================================================== -->
    <!--  CALCULATOR 1 - STORY HOURS -->
    <!-- ====================================================== -->
    <div class="bg-white shadow-lg p-6 rounded-xl">

        <div class="flex items-center justify-between">
            <h2 class="text-xl font-semibold">Story Hours</h2>

            <button onclick="addStory()"
                class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">
                + Add Story
            </button>
        </div>

        <!-- Preset Buttons -->
        <div class="mt-4 flex gap-3">
            <button onclick="applyPreset([3,2,2])"
                class="bg-gray-200 px-3 py-1 rounded-lg">3,2,2</button>

            <button onclick="applyPreset([5,3,2,1])"
                class="bg-gray-200 px-3 py-1 rounded-lg">5,3,2,1</button>

            <button onclick="applyPreset([1,1,1])"
                class="bg-gray-200 px-3 py-1 rounded-lg">1,1,1</button>
        </div>

        <!-- Story Table -->
        <div class="overflow-x-auto mt-6">
            <table id="storyTable" class="w-full border text-center">
                <tr class="bg-gray-200 font-semibold">
                    <th class="border p-2">#</th>
                    <th class="border p-2">Points</th>
                    <th class="border p-2">Dev Hours</th>
                    <th class="border p-2">QA Hours</th>
                    <th class="border p-2">Dev Buffer</th>
                    <th class="border p-2">QA Buffer</th>
                    <th class="border p-2">Total</th>
                    <th class="border p-2">Delete</th>
                </tr>
            </table>
        </div>

        <div class="text-lg font-bold mt-4">
            Grand Total: <span id="grandTotal">0</span> hrs
        </div>

        <div id="validationMsg" class="text-red-600 font-semibold mt-2"></div>
    </div>



    <!-- ====================================================== -->
    <!--  CALCULATOR 2 - JAVA LOGIC SPLITTER -->
    <!-- ====================================================== -->
    <div class="bg-white shadow-lg p-6 rounded-xl">

        <h2 class="text-xl font-semibold">Dev Hours Split (Java Logic)</h2>

        <div class="mt-4">
            <label class="font-medium">Total Dev Hours:</label>
            <input type="number" id="splitTotalHours" value="54"
                class="border w-40 px-3 py-2 rounded-lg ml-3"
                oninput="runSplitter()">
        </div>

        <div class="overflow-x-auto mt-6">
            <table id="splitResultTable" class="w-full border text-center">
                <tr class="bg-gray-200 font-semibold">
                    <th class="border p-2">Story #</th>
                    <th class="border p-2">Points</th>
                    <th class="border p-2">Allocated Hours</th>
                </tr>
            </table>
        </div>
    </div>


</div>



<!-- ====================================================== -->
<!-- JAVASCRIPT -->
<!-- ====================================================== -->
<script>
let storyCount = 0;

function addStory(pointsValue = 1) {
    storyCount++;

    const table = document.getElementById("storyTable");
    let row = table.insertRow(-1);

    row.innerHTML = `
        <td class="border p-2">${storyCount}</td>
        <td class="border p-2">
            <input type="number" class="points w-full border rounded px-2 py-1"
                value="${pointsValue}" min="1" oninput="recalcAll()">
        </td>

        <td class="border p-2">
            <input type="number" class="dev w-full border rounded px-2 py-1"
                value="${pointsValue * 6}" oninput="devChanged(this)">
        </td>

        <td class="border p-2">
            <input type="number" class="qa w-full border rounded px-2 py-1"
                value="${pointsValue * 4}" oninput="calculate()">
        </td>

        <td class="border p-2">
            <input type="number" class="devBuf w-full border rounded px-2 py-1"
                value="0" oninput="calculate()">
        </td>

        <td class="border p-2">
            <input type="number" class="qaBuf w-full border rounded px-2 py-1"
                value="0" oninput="calculate()">
        </td>

        <td class="storyTotal border p-2 font-semibold">10</td>

        <td class="border p-2">
            <button onclick="deleteRow(this)"
                class="bg-red-500 text-white px-3 py-1 rounded">
                X
            </button>
        </td>
    `;

    calculate();
    runSplitter();
}

function deleteRow(btn) {
    const row = btn.parentNode.parentNode;
    row.remove();
    renumberStories();
    calculate();
    runSplitter();
}

function renumberStories() {
    const rows = document.querySelectorAll("#storyTable tr");
    storyCount = 0;
    for (let i = 1; i < rows.length; i++) {
        storyCount++;
        rows[i].cells[0].innerText = storyCount;
    }
}

function applyPreset(pointsList) {
    document.querySelectorAll("#storyTable tr:not(:first-child)").forEach(r => r.remove());
    storyCount = 0;

    pointsList.forEach(p => addStory(p));
}

function devChanged(input) {
    const row = input.parentNode.parentNode;
    const points = Number(row.querySelector(".points").value);
    row.querySelector(".qa").value = points * 4;
    calculate();
}

function calculate() {
    let rows = document.querySelectorAll("#storyTable tr");
    let grand = 0;

    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        let points = Number(row.querySelector(".points").value);
        let dev = Number(row.querySelector(".dev").value);
        let qa = Number(row.querySelector(".qa").value);
        let devBuf = Number(row.querySelector(".devBuf").value);
        let qaBuf = Number(row.querySelector(".qaBuf").value);

        let total = dev + qa + devBuf + qaBuf;
        let expected = points * 10;

        let cell = row.querySelector(".storyTotal");
        cell.innerText = total;

        if (total !== expected) cell.classList.add("red");
        else cell.classList.remove("red");

        grand += total;
    }

    document.getElementById("grandTotal").innerText = grand;
    validate(grand);
    runSplitter();
}

function validate(grand) {
    const msg = document.getElementById("validationMsg");
    msg.innerHTML = grand % 10 !== 0
        ? "⚠️ Total does not align with point rules!"
        : "";
}

function recalcAll() {
    calculate();
    runSplitter();
}

function runSplitter() {
    let table = document.getElementById("splitResultTable");
    while (table.rows.length > 1) table.deleteRow(1);

    // Collect points from Calculator 1
    let pointsArr = Array.from(document.querySelectorAll("#storyTable .points"))
        .map(inp => Number(inp.value));

    if (pointsArr.length === 0) return;

    // New simple rule: hours = points * 6
    for (let i = 0; i < pointsArr.length; i++) {
        let pts = pointsArr[i];
        let hrs = pts * 6;

        let row = table.insertRow(-1);
        row.innerHTML = `
            <td class="border p-2">${i + 1}</td>
            <td class="border p-2">${pts}</td>
            <td class="border p-2">${hrs}</td>
        `;
    }
}

function splitHoursByStoryPoints(totalHours, storyPoints) {
    let totalPoints = storyPoints.reduce((a,b)=>a+b,0);
    let remainingHours = totalHours;
    let remainingPoints = totalPoints;
    let result = [];

    for (let pts of storyPoints) {
        let hrs = Math.round((pts / remainingPoints) * remainingHours);
        result.push(hrs);
        remainingHours -= hrs;
        remainingPoints -= pts;
    }

    let i = 0;
    while (remainingHours > 0) {
        result[i]++;
        remainingHours--;
        i = (i + 1) % result.length;
    }

    return result;
}

addStory();
</script>

</body>
</html>
