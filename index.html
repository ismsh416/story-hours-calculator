<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Story Hours Calculator</title>
    <style>
        body {
            font-family: Arial;
            padding: 20px;
            max-width: 1000px;
            margin: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
            position: relative; /* important */
        }

        input {
            width: 100%;
            padding: 6px;
            background: white;
            box-sizing: border-box;
        }

        .add-btn {
            padding: 10px 18px;
            margin-top: 15px;
            background: black;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 6px;
        }

        .section-title {
            margin-top: 35px;
            font-size: 22px;
            font-weight: bold;
        }

        .total-box {
            margin-top: 20px;
            padding: 15px;
            background: #f3f3f3;
            font-size: 18px;
            font-weight: bold;
        }

        .red {
            color: red;
            font-weight: bold;
        }
    </style>
</head>

<body>

<h2>Story Hours Calculator</h2>

<button class="add-btn" onclick="addStory()">+ Add Story</button>

<table id="storyTable">
    <tr>
        <th>Story #</th>
        <th>Points</th>
        <th>Dev Hours</th>
        <th>QA Hours</th>
        <th>Dev Buffer</th>
        <th>QA Buffer</th>
        <th>Total Hours</th>
    </tr>
</table>

<div class="total-box">
    Grand Total: <span id="grandTotal">0</span> hrs
</div>

<!-- ------------------ CALCULATOR 2 ------------------ -->

<div class="section-title">Dev Hours Split Based on Story Points</div>

<label>Total Dev Hours:</label>
<input type="number" id="splitTotalHours" value="54" oninput="runSplitter()" />

<table id="splitResultTable">
    <tr>
        <th>Story #</th>
        <th>Points</th>
        <th>Allocated Hours</th>
    </tr>
</table>


<script>
let storyCount = 0;

function addStory() {
    storyCount++;

    let table = document.getElementById("storyTable");
    let row = table.insertRow(-1);

    row.innerHTML = `
        <td>${storyCount}</td>
        <td><input type="number" class="points" min="1" value="1" oninput="recalcAll()"></td>
        <td><input type="number" class="dev" min="0" value="6" oninput="devChanged(this)"></td>
        <td><input type="number" class="qa" min="0" value="4" oninput="calculate()"></td>
        <td><input type="number" class="devBuf" min="0" value="0" oninput="calculate()"></td>
        <td><input type="number" class="qaBuf" min="0" value="0" oninput="calculate()"></td>
        <td class="storyTotal">10</td>
    `;

    runSplitter();
    calculate();
}

function devChanged(devInput) {
    let row = devInput.parentNode.parentNode;
    let points = Number(row.querySelector(".points").value);
    let qaInput = row.querySelector(".qa");
    qaInput.value = points * 4;
    calculate();
}

function calculate() {
    let rows = document.getElementById("storyTable").rows;
    let grand = 0;

    for (let i = 1; i < rows.length; i++) {
        let row = rows[i];

        let points = Number(row.querySelector(".points").value);
        let dev = Number(row.querySelector(".dev").value);
        let qa = Number(row.querySelector(".qa").value);
        let devBuf = Number(row.querySelector(".devBuf").value);
        let qaBuf = Number(row.querySelector(".qaBuf").value);

        let total = dev + qa + devBuf + qaBuf;
        let expected = points * 10;

        let totalCell = row.querySelector(".storyTotal");
        totalCell.innerText = total;

        if (total !== expected) {
            totalCell.classList.add("red");
        } else {
            totalCell.classList.remove("red");
        }

        grand += total;
    }

    document.getElementById("grandTotal").innerText = grand;
    runSplitter();
}

function recalcAll() {
    calculate();
    runSplitter();
}

function runSplitter() {
    let splitTable = document.getElementById("splitResultTable");

    while (splitTable.rows.length > 1) {
        splitTable.deleteRow(1);
    }

    let totalHours = Number(document.getElementById("splitTotalHours").value);
    let pointsArr = [];

    let rows = document.getElementById("storyTable").rows;
    for (let i = 1; i < rows.length; i++) {
        pointsArr.push(Number(rows[i].querySelector(".points").value));
    }

    if (pointsArr.length === 0) return;

    let allocated = splitHoursByStoryPoints(totalHours, pointsArr);

    for (let i = 0; i < pointsArr.length; i++) {
        let row = splitTable.insertRow(-1);
        row.innerHTML = `
            <td>${i + 1}</td>
            <td>${pointsArr[i]}</td>
            <td>${allocated[i]}</td>
        `;
    }
}

function splitHoursByStoryPoints(totalHours, storyPoints) {
    let totalPoints = storyPoints.reduce((a, b) => a + b, 0);
    let remainingHours = totalHours;
    let remainingPoints = totalPoints;

    let hoursPerStory = [];

    for (let pts of storyPoints) {
        let hrs = Math.round((pts / remainingPoints) * remainingHours);
        hoursPerStory.push(hrs);
        remainingHours -= hrs;
        remainingPoints -= pts;
    }

    let i = 0;
    while (remainingHours > 0) {
        hoursPerStory[i] += 1;
        remainingHours--;
        i = (i + 1) % hoursPerStory.length;
    }

    return hoursPerStory;
}

addStory();
</script>

</body>
</html>
